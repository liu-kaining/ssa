<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票交易策略分析工具</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        h1 {
            color: var(--dark-color);
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background: var(--primary-color);
            color: white;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .col {
            flex: 1;
            padding: 0 10px;
        }
        
        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background 0.3s;
            display: inline-block;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: var(--secondary-color);
        }
        
        .btn-secondary:hover {
            background: #27ae60;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .button-group .btn {
            margin-top: 0;
            flex: 1;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.95rem;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .positive {
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .negative {
            color: var(--danger-color);
            font-weight: 600;
        }
        
        .neutral {
            color: #7f8c8d;
        }
        
        .summary-box {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }
        
        .summary-item {
            text-align: center;
            padding: 10px;
            min-width: 150px;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 5px 0;
        }
        
        .summary-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin: 30px 0;
        }
        
        .chart-wrapper {
            flex: 1;
            min-width: 400px;
            height: 500px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 25px;
            border: 1px solid rgba(52, 152, 219, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .chart-wrapper:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(52, 152, 219, 0.2);
        }
        
        .chart-wrapper canvas {
            max-height: 450px !important;
        }
        
        .chart-header {
            text-align: center;
            margin-bottom: 15px;
            color: var(--dark-color);
            font-weight: 600;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            position: relative;
            top: 1px;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stock-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .strategy-selector {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .strategy-option {
            flex: 1;
            min-width: 200px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            header {
                margin-bottom: 20px;
                padding: 15px 0;
            }
            
            h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .card-body {
                padding: 15px;
            }
            
            .card-header {
                padding: 12px 15px;
                font-size: 1.1rem;
            }
            
            .col {
                flex: 100%;
                margin-bottom: 10px;
            }
            
            .row {
                flex-direction: column;
                margin: 0;
            }
            
            .form-group {
                margin-bottom: 12px;
            }
            
            label {
                font-size: 0.95rem;
                margin-bottom: 4px;
            }
            
            input[type="text"],
            input[type="number"],
            select {
                padding: 12px;
                font-size: 16px; /* 防止iOS缩放 */
                border-radius: 6px;
            }
            
            .btn {
                width: 100%;
                padding: 15px;
                font-size: 1.1rem;
                margin-top: 15px;
            }
            
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .summary-box {
                flex-direction: column;
                padding: 12px;
            }
            
            .summary-item {
                margin-bottom: 15px;
                min-width: auto;
            }
            
            .summary-value {
                font-size: 1.3rem;
            }
            
            .summary-label {
                font-size: 0.85rem;
            }
            
            .charts-container {
                flex-direction: column;
                gap: 20px;
                margin: 20px 0;
            }
            
            .chart-wrapper {
                min-width: 100%;
                height: 350px;
                padding: 20px 15px;
            }
            
            .chart-wrapper canvas {
                max-height: 300px !important;
            }
            
            .tabs {
                flex-wrap: wrap;
                margin-bottom: 15px;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                padding: 12px 15px;
                font-size: 0.9rem;
                text-align: center;
            }
            
            .stock-info {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .info-item {
                padding: 12px;
            }
            
            .strategy-selector {
                flex-direction: column;
                gap: 15px;
            }
            
            .strategy-option {
                min-width: 100%;
            }
            
            /* 移动端表格优化 */
            table {
                font-size: 0.85rem;
                margin-top: 10px;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
            
            /* 移动端表格横向滚动 */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 15px 0;
            }
            
            table {
                min-width: 600px; /* 确保表格有最小宽度 */
            }
            
            /* 移动端标签页内容间距 */
            .tab-content {
                padding: 15px 0;
            }
            
            /* 移动端图表标题 */
            .chart-header {
                font-size: 1rem;
                margin-bottom: 12px;
            }
            
            /* 移动端页脚 */
            footer {
                margin-top: 30px;
                padding: 15px;
                font-size: 0.8rem;
            }
            
            footer p {
                margin-bottom: 8px;
            }
        }
        
        /* 超小屏幕优化 */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            .card-body {
                padding: 12px;
            }
            
            .card-header {
                padding: 10px 12px;
                font-size: 1rem;
            }
            
            input[type="text"],
            input[type="number"],
            select {
                padding: 10px;
                font-size: 16px;
            }
            
            .btn {
                padding: 12px;
                font-size: 1rem;
            }
            
            .button-group {
                gap: 8px;
            }
            
            .chart-wrapper {
                height: 300px;
                padding: 15px 10px;
            }
            
            .chart-wrapper canvas {
                max-height: 250px !important;
            }
            
            .tab {
                padding: 10px 12px;
                font-size: 0.85rem;
                min-width: 100px;
            }
            
            .summary-value {
                font-size: 1.2rem;
            }
            
            .summary-label {
                font-size: 0.8rem;
            }
            
            /* 超小屏幕表格字体 */
            table {
                font-size: 0.75rem;
            }
            
            th, td {
                padding: 6px 4px;
                font-size: 0.7rem;
            }
        }
        
        /* 横屏模式优化 */
        @media (max-width: 768px) and (orientation: landscape) {
            .chart-wrapper {
                height: 250px;
            }
            
            .chart-wrapper canvas {
                max-height: 200px !important;
            }
            
            .container {
                padding: 10px;
            }
            
            header {
                margin-bottom: 15px;
                padding: 10px 0;
            }
            
            h1 {
                font-size: 1.5rem;
            }
        }
        
        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px; /* iOS推荐的最小触摸目标 */
            }
            
            .tab {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            input[type="text"],
            input[type="number"],
            select {
                min-height: 44px;
            }
            
            /* 触摸友好的表格 */
            .table-container {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            /* 触摸友好的图表 */
            .chart-wrapper {
                touch-action: pan-x pan-y;
            }
        }
        
        /* 高分辨率屏幕优化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .chart-wrapper {
                border-width: 0.5px;
            }
            
            input[type="text"],
            input[type="number"],
            select {
                border-width: 0.5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>股票交易策略分析工具</h1>
            <p class="subtitle">基于动态买入策略的收益分析与可视化</p>
        </header>
        
        <div class="card">
            <div class="card-header">股票基本信息</div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="marketType">市场类型</label>
                            <select id="marketType" onchange="updateMarketSettings()">
                                <option value="HK">港股</option>
                                <option value="US">美股</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="companyName">公司名称</label>
                            <input type="text" id="companyName" value="美图" required>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="stockCode">股票代码</label>
                            <input type="text" id="stockCode" value="01357" required>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="currentPrice">当前股价</label>
                            <input type="number" id="currentPrice" value="4.37" step="0.01" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="historicalHigh">历史最高价</label>
                            <input type="number" id="historicalHigh" value="22.04" step="0.01" required>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="historicalLow">历史最低价</label>
                            <input type="number" id="historicalLow" value="0.62" step="0.01" required>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="week52High">52周最高价</label>
                            <input type="number" id="week52High" value="6.75" step="0.01" required>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="week52Low">52周最低价</label>
                            <input type="number" id="week52Low" value="1.96" step="0.01" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="marketCap">当前市值</label>
                            <input type="number" id="marketCap" value="199.29" step="0.01" required>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="totalShares">总股本 (亿股)</label>
                            <input type="number" id="totalShares" value="45.6" step="0.1" required>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="sharesPerHand">每手股数</label>
                            <input type="number" id="sharesPerHand" value="500" step="1" required>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">交易策略设置</div>
            <div class="card-body">
                <div class="strategy-selector">
                    <div class="strategy-option">
                        <div class="form-group">
                            <label for="strategyACondition">策略A：价格变化条件</label>
                            <select id="strategyACondition" required>
                                <option value="down">下跌</option>
                                <option value="up">上涨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="strategyAPercentage">策略A：百分比 (%)</label>
                            <input type="number" id="strategyAPercentage" value="10" step="1" required>
                        </div>
                        <div class="form-group">
                            <label for="strategyAHands">策略A：购入手数</label>
                            <input type="number" id="strategyAHands" value="4" step="1" required>
                        </div>
                    </div>
                    
                    <div class="strategy-option">
                        <div class="form-group">
                            <label for="strategyBCondition">策略B：价格变化条件</label>
                            <select id="strategyBCondition" required>
                                <option value="up">上涨</option>
                                <option value="down">下跌</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="strategyBPercentage">策略B：百分比 (%)</label>
                            <input type="number" id="strategyBPercentage" value="10" step="1" required>
                        </div>
                        <div class="form-group">
                            <label for="strategyBHands">策略B：购入手数</label>
                            <input type="number" id="strategyBHands" value="3" step="1" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="totalBudget">总投资预算 <span id="budgetUnit">港元</span></label>
                            <input type="number" id="totalBudget" value="32000" step="100" required>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="maxBuys">最大买入次数</label>
                            <input type="number" id="maxBuys" value="10" step="1" required>
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn" id="generateStrategyBtn" onclick="confirmGenerateStrategy()" disabled>生成交易策略</button>
                    <button class="btn btn-secondary" id="resetBtn" onclick="confirmReset()">一键重置</button>
                </div>
            </div>
        </div>
        
        <div id="results" style="display: none;">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('strategyA')">策略A分析</div>
                <div class="tab" onclick="switchTab('strategyB')">策略B分析</div>
                <div class="tab" onclick="switchTab('comparison')">策略对比</div>
            </div>
            
            <div id="strategyA" class="tab-content active">
                <div class="card">
                    <div class="card-header">策略A：下跌10%时买入4手</div>
                    <div class="card-body">
                        <div class="summary-box">
                            <div class="summary-item">
                                <div class="summary-value" id="strategyA-totalShares">0</div>
                                <div class="summary-label">持有股数</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="strategyA-totalSpent">0</div>
                                <div class="summary-label">总支出</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="strategyA-remainingBudget">0</div>
                                <div class="summary-label">剩余预算</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="strategyA-averageCost">0</div>
                                <div class="summary-label">平均成本</div>
                            </div>
                        </div>
                        
                        <h3>买入计划</h3>
                        <div class="table-container">
                            <table id="strategyA-buyPlan">
                                <thead>
                                    <tr>
                                        <th>序号</th>
                                        <th>预期价格</th>
                                        <th>购入手数</th>
                                        <th>购入股数</th>
                                        <th>支出</th>
                                        <th>累计支出</th>
                                        <th>剩余预算</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态生成的表格行 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <h3 style="margin-top: 30px;">收益分析</h3>
                        <div class="table-container">
                            <table id="strategyA-profitAnalysis">
                                <thead>
                                    <tr>
                                        <th>目标价格</th>
                                        <th>公司市值</th>
                                        <th>持仓价值</th>
                                        <th>收益</th>
                                        <th>收益率</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态生成的表格行 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="charts-container">
                            <div class="chart-wrapper">
                                <div class="chart-header">收益与收益率变化</div>
                                <canvas id="strategyA-profitChart"></canvas>
                            </div>
                            <div class="chart-wrapper">
                                <div class="chart-header">买入计划分布</div>
                                <canvas id="strategyA-buyPlanChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="strategyB" class="tab-content">
                <div class="card">
                    <div class="card-header">策略B：下跌10%时买入3手</div>
                    <div class="card-body">
                        <div class="summary-box">
                            <div class="summary-item">
                                <div class="summary-value" id="strategyB-totalShares">0</div>
                                <div class="summary-label">持有股数</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="strategyB-totalSpent">0</div>
                                <div class="summary-label">总支出</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="strategyB-remainingBudget">0</div>
                                <div class="summary-label">剩余预算</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="strategyB-averageCost">0</div>
                                <div class="summary-label">平均成本</div>
                            </div>
                        </div>
                        
                        <h3>买入计划</h3>
                        <div class="table-container">
                            <table id="strategyB-buyPlan">
                                <thead>
                                    <tr>
                                        <th>序号</th>
                                        <th>预期价格</th>
                                        <th>购入手数</th>
                                        <th>购入股数</th>
                                        <th>支出</th>
                                        <th>累计支出</th>
                                        <th>剩余预算</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态生成的表格行 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <h3 style="margin-top: 30px;">收益分析</h3>
                        <div class="table-container">
                            <table id="strategyB-profitAnalysis">
                                <thead>
                                    <tr>
                                        <th>目标价格</th>
                                        <th>公司市值</th>
                                        <th>持仓价值</th>
                                        <th>收益</th>
                                        <th>收益率</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 动态生成的表格行 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="charts-container">
                            <div class="chart-wrapper">
                                <div class="chart-header">收益与收益率变化</div>
                                <canvas id="strategyB-profitChart"></canvas>
                            </div>
                            <div class="chart-wrapper">
                                <div class="chart-header">买入计划分布</div>
                                <canvas id="strategyB-buyPlanChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="comparison" class="tab-content">
                <div class="card">
                    <div class="card-header">策略对比分析</div>
                    <div class="card-body">
                        <div class="charts-container">
                            <div class="chart-wrapper">
                                <div class="chart-header">策略收益对比</div>
                                <canvas id="comparison-profitChart"></canvas>
                            </div>
                            <div class="chart-wrapper">
                                <div class="chart-header">策略收益率对比</div>
                                <canvas id="comparison-rateChart"></canvas>
                            </div>
                        </div>
                        
                        <h3 style="margin-top: 30px;">策略关键指标对比</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>指标</th>
                                        <th>策略A</th>
                                        <th>策略B</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>总支出</td>
                                        <td id="comparison-totalSpent-A">0</td>
                                        <td id="comparison-totalSpent-B">0</td>
                                    </tr>
                                    <tr>
                                        <td>持有股数</td>
                                        <td id="comparison-totalShares-A">0</td>
                                        <td id="comparison-totalShares-B">0</td>
                                    </tr>
                                    <tr>
                                        <td>平均成本</td>
                                        <td id="comparison-averageCost-A">0</td>
                                        <td id="comparison-averageCost-B">0</td>
                                    </tr>
                                    <tr>
                                        <td>盈亏平衡点</td>
                                        <td id="comparison-breakEven-A">0</td>
                                        <td id="comparison-breakEven-B">0</td>
                                    </tr>
                                    <tr>
                                        <td>回本所需涨幅</td>
                                        <td id="comparison-returnRate-A">0</td>
                                        <td id="comparison-returnRate-B">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="card" style="margin-top: 30px;">
                            <div class="card-header">策略建议</div>
                            <div class="card-body">
                                <p id="strategy-suggestion">请先生成策略分析以获取建议。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>股票交易策略分析工具 &copy; 2025 | 本工具仅供学习参考，不构成投资建议</p>
            <p>作者: <a href="https://github.com/liu-kaining" target="_blank" style="color: #3498db; text-decoration: none;">liukaining</a> | <a href="https://github.com/liu-kaining" target="_blank" style="color: #3498db; text-decoration: none;">@https://github.com/liu-kaining</a></p>
        </footer>
    </div>

    <script>
        // 全局变量存储策略数据
        let strategyAData = null;
        let strategyBData = null;
        
        // 切换标签页
        function switchTab(tabId) {
            // 移除所有active类
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 添加active类到选中的标签页
            const tabElement = document.querySelector(`[onclick="switchTab('${tabId}')"]`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            const contentElement = document.getElementById(tabId);
            if (contentElement) {
                contentElement.classList.add('active');
            }
        }
        
        // 更新市场设置
        function updateMarketSettings() {
            const marketType = document.getElementById('marketType').value;
            
            if (marketType === 'US') {
                // 美股设置
                document.getElementById('currentPrice').value = '150.00';
                document.getElementById('historicalHigh').value = '200.00';
                document.getElementById('historicalLow').value = '50.00';
                document.getElementById('week52High').value = '180.00';
                document.getElementById('week52Low').value = '80.00';
                document.getElementById('marketCap').value = '2500.00';
                document.getElementById('totalShares').value = '16.5';
                document.getElementById('sharesPerHand').value = '100';
                document.getElementById('totalBudget').value = '50000';
                document.getElementById('companyName').value = 'Apple Inc.';
                document.getElementById('stockCode').value = 'AAPL';
                document.getElementById('budgetUnit').textContent = '美元';
            } else {
                // 港股设置
                document.getElementById('currentPrice').value = '4.37';
                document.getElementById('historicalHigh').value = '22.04';
                document.getElementById('historicalLow').value = '0.62';
                document.getElementById('week52High').value = '6.75';
                document.getElementById('week52Low').value = '1.96';
                document.getElementById('marketCap').value = '199.29';
                document.getElementById('totalShares').value = '45.6';
                document.getElementById('sharesPerHand').value = '500';
                document.getElementById('totalBudget').value = '32000';
                document.getElementById('companyName').value = '美图';
                document.getElementById('stockCode').value = '01357';
                document.getElementById('budgetUnit').textContent = '港元';
            }
            validateForm(); // 更新市场设置后验证表单
        }
        
        // 验证表单
        function validateForm() {
            const requiredFields = [
                'companyName', 'stockCode', 'currentPrice', 'historicalHigh', 'historicalLow',
                'week52High', 'week52Low', 'marketCap', 'totalShares', 'sharesPerHand',
                'strategyACondition', 'strategyAPercentage', 'strategyAHands',
                'strategyBCondition', 'strategyBPercentage', 'strategyBHands',
                'totalBudget', 'maxBuys'
            ];
            
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const value = field.value.trim();
                
                if (!value || value === '') {
                    isValid = false;
                    field.style.borderColor = '#e74c3c';
                } else {
                    field.style.borderColor = '#ddd';
                }
            });
            
            // 更新按钮状态
            const generateBtn = document.getElementById('generateStrategyBtn');
            if (isValid) {
                generateBtn.disabled = false;
                generateBtn.style.opacity = '1';
                generateBtn.style.cursor = 'pointer';
            } else {
                generateBtn.disabled = true;
                generateBtn.style.opacity = '0.6';
                generateBtn.style.cursor = 'not-allowed';
            }
            
            return isValid;
        }
        
        // 添加输入事件监听器
        function addInputListeners() {
            const requiredFields = [
                'companyName', 'stockCode', 'currentPrice', 'historicalHigh', 'historicalLow',
                'week52High', 'week52Low', 'marketCap', 'totalShares', 'sharesPerHand',
                'strategyACondition', 'strategyAPercentage', 'strategyAHands',
                'strategyBCondition', 'strategyBPercentage', 'strategyBHands',
                'totalBudget', 'maxBuys'
            ];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', validateForm);
                    field.addEventListener('change', validateForm);
                }
            });
        }
        
        // 更新策略标题
        function updateStrategyTitles(strategyACondition, strategyAPercentage, strategyAHands, 
                                   strategyBCondition, strategyBPercentage, strategyBHands) {
            const conditionTextA = strategyACondition === 'down' ? '下跌' : '上涨';
            const conditionTextB = strategyBCondition === 'down' ? '下跌' : '上涨';
            
            const strategyAHeader = document.querySelector('#strategyA .card-header');
            const strategyBHeader = document.querySelector('#strategyB .card-header');
            
            if (strategyAHeader) {
                strategyAHeader.textContent = `策略A：${conditionTextA}${strategyAPercentage}%时买入${strategyAHands}手`;
            }
            if (strategyBHeader) {
                strategyBHeader.textContent = `策略B：${conditionTextB}${strategyBPercentage}%时买入${strategyBHands}手`;
            }
        }
        
        // 确认生成交易策略
        function confirmGenerateStrategy() {
            if (confirm('确定要生成交易策略吗？这将基于当前设置计算详细的投资计划。')) {
                calculateStrategies();
            }
        }
        
        // 确认重置
        function confirmReset() {
            if (confirm('确定要重置所有设置吗？这将清空所有输入数据和计算结果。')) {
                resetAllData();
            }
        }
        
        // 重置所有数据
        function resetAllData() {
            // 重置股票基本信息
            document.getElementById('marketType').value = 'HK';
            document.getElementById('companyName').value = '美图';
            document.getElementById('stockCode').value = '01357';
            document.getElementById('currentPrice').value = '';
            document.getElementById('totalBudget').value = '';
            document.getElementById('sharesPerHand').value = '100';
            document.getElementById('maxBuys').value = '10';
            document.getElementById('historicalHigh').value = '';
            document.getElementById('historicalLow').value = '';
            document.getElementById('week52High').value = '';
            document.getElementById('week52Low').value = '';
            document.getElementById('marketCap').value = '';
            document.getElementById('totalShares').value = '';
            
            // 重置交易策略设置
            document.getElementById('strategyACondition').value = 'down';
            document.getElementById('strategyAPercentage').value = '10';
            document.getElementById('strategyAHands').value = '4';
            document.getElementById('strategyBCondition').value = 'up';
            document.getElementById('strategyBPercentage').value = '10';
            document.getElementById('strategyBHands').value = '3';
            
            // 隐藏结果区域
            document.getElementById('results').style.display = 'none';
            
            // 重置表单验证状态
            document.getElementById('generateStrategyBtn').disabled = true;
            
            // 重置表单边框颜色
            const requiredFields = [
                'companyName', 'stockCode', 'currentPrice', 'historicalHigh', 'historicalLow',
                'week52High', 'week52Low', 'marketCap', 'totalShares', 'sharesPerHand',
                'strategyACondition', 'strategyAPercentage', 'strategyAHands',
                'strategyBCondition', 'strategyBPercentage', 'strategyBHands',
                'totalBudget', 'maxBuys'
            ];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.style.borderColor = '#ddd';
                }
            });
            
            // 清空所有图表
            if (window.strategyAProfitChart) {
                window.strategyAProfitChart.destroy();
                window.strategyAProfitChart = null;
            }
            if (window.strategyABuyPlanChart) {
                window.strategyABuyPlanChart.destroy();
                window.strategyABuyPlanChart = null;
            }
            if (window.strategyBProfitChart) {
                window.strategyBProfitChart.destroy();
                window.strategyBProfitChart = null;
            }
            if (window.strategyBBuyPlanChart) {
                window.strategyBBuyPlanChart.destroy();
                window.strategyBBuyPlanChart = null;
            }
            if (window.comparisonChart) {
                window.comparisonChart.destroy();
                window.comparisonChart = null;
            }
            
            // 重置数据变量
            strategyAData = null;
            strategyBData = null;
            
            // 显示成功消息
            alert('所有数据已重置！');
        }
        
        // 计算策略
        function calculateStrategies() {
            // 验证表单
            if (!validateForm()) {
                alert('请填写所有必填字段！');
                return;
            }
            
            // 获取输入值
            const currentPrice = parseFloat(document.getElementById('currentPrice').value);
            const totalBudget = parseFloat(document.getElementById('totalBudget').value);
            const maxBuys = parseInt(document.getElementById('maxBuys').value);
            const sharesPerHand = parseInt(document.getElementById('sharesPerHand').value);
            
            // 获取策略A参数
            const strategyACondition = document.getElementById('strategyACondition').value;
            const strategyAPercentage = parseFloat(document.getElementById('strategyAPercentage').value) / 100;
            const strategyAHands = parseInt(document.getElementById('strategyAHands').value);
            
            // 获取策略B参数
            const strategyBCondition = document.getElementById('strategyBCondition').value;
            const strategyBPercentage = parseFloat(document.getElementById('strategyBPercentage').value) / 100;
            const strategyBHands = parseInt(document.getElementById('strategyBHands').value);
            
            // 更新策略标题
            updateStrategyTitles(strategyACondition, strategyAPercentage * 100, strategyAHands, 
                               strategyBCondition, strategyBPercentage * 100, strategyBHands);
            
            // 计算策略A
            strategyAData = calculateStrategy(
                currentPrice, 
                totalBudget, 
                maxBuys, 
                sharesPerHand, 
                strategyACondition, 
                strategyAPercentage, 
                strategyAHands,
                'A'
            );
            
            // 计算策略B
            strategyBData = calculateStrategy(
                currentPrice, 
                totalBudget, 
                maxBuys, 
                sharesPerHand, 
                strategyBCondition, 
                strategyBPercentage, 
                strategyBHands,
                'B'
            );
            

            
            // 显示结果
            displayResults();
            
            // 显示结果区域
            document.getElementById('results').style.display = 'block';
        }
        
        // 计算单个策略
        function calculateStrategy(currentPrice, totalBudget, maxBuys, sharesPerHand, condition, percentage, hands, strategyName) {
            const data = {
                buyPlan: [],
                profitAnalysis: [],
                totalShares: 0,
                totalSpent: 0,
                remainingBudget: totalBudget,
                averageCost: 0
            };
            
            let currentPriceCalc = currentPrice;
            let remainingBudget = totalBudget;
            let totalSpent = 0;
            let totalShares = 0;
            
            // 计算买入计划
            for (let i = 0; i < maxBuys; i++) {
                // 根据条件调整价格
                let buyPrice;
                if (condition === 'down') {
                    buyPrice = currentPriceCalc * Math.pow(1 - percentage, i);
                } else {
                    buyPrice = currentPriceCalc * Math.pow(1 + percentage, i);
                }
                
                // 优化价格精度，使其更实用
                const marketType = document.getElementById('marketType').value;
                if (marketType === 'US') {
                    // 美股：价格保留到整数
                    buyPrice = Math.round(buyPrice);
                } else {
                    // 港股：价格保留到0.1港元
                    buyPrice = Math.round(buyPrice * 10) / 10;
                }
                
                const sharesToBuy = hands * sharesPerHand;
                const cost = sharesToBuy * buyPrice;
                
                // 检查预算是否足够
                if (remainingBudget < cost) {
                    break;
                }
                
                // 更新数据
                remainingBudget -= cost;
                totalSpent += cost;
                totalShares += sharesToBuy;
                
                // 添加到买入计划
                data.buyPlan.push({
                    sequence: i + 1,
                    price: buyPrice,
                    hands: hands,
                    shares: sharesToBuy,
                    cost: cost,
                    cumulativeCost: totalSpent,
                    remainingBudget: remainingBudget
                });
            }
            
            // 计算平均成本
            data.totalShares = totalShares;
            data.totalSpent = totalSpent;
            data.remainingBudget = remainingBudget;
            data.averageCost = totalShares > 0 ? totalSpent / totalShares : 0;
            
            // 计算收益分析 (目标价格使用更实用的价格区间)
            const marketType = document.getElementById('marketType').value;
            const marketCap = parseFloat(document.getElementById('marketCap').value) * 100000000; // 转换为基础货币单位
            const totalSharesCount = parseFloat(document.getElementById('totalShares').value) * 100000000; // 转换为股数
            const historicalHigh = parseFloat(document.getElementById('historicalHigh').value); // 历史最高价
            
            // 计算目标价格范围：使用更实用的价格区间
            let minPrice, maxPrice;
            
            if (marketType === 'US') {
                // 美股：从当前价格的80%到历史最高价的120%，使用整数价格
                minPrice = Math.floor(currentPrice * 0.8);
                maxPrice = Math.ceil(historicalHigh * 1.2);
                // 每5美元一个价格点
                const stepSize = 5;
                for (let price = minPrice; price <= maxPrice; price += stepSize) {
                    const targetPrice = price;
                    const holdingValue = totalShares * targetPrice;
                    const profit = holdingValue - totalSpent;
                    const profitRate = totalSpent > 0 ? (profit / totalSpent) * 100 : 0;
                    const companyMarketCap = (targetPrice / currentPrice) * marketCap / 100000000; // 转换为亿单位
                    
                    data.profitAnalysis.push({
                        targetPrice: targetPrice,
                        companyMarketCap: companyMarketCap,
                        holdingValue: holdingValue,
                        profit: profit,
                        profitRate: profitRate
                    });
                }
            } else {
                // 港股：从当前价格的80%到历史最高价的120%，使用0.5港元的价格点
                minPrice = Math.floor(currentPrice * 0.8 * 2) / 2;
                maxPrice = Math.ceil(historicalHigh * 1.2 * 2) / 2;
                // 每0.5港元一个价格点
                const stepSize = 0.5;
                for (let price = minPrice; price <= maxPrice; price += stepSize) {
                    const targetPrice = Math.round(price * 2) / 2; // 保留一位小数
                    const holdingValue = totalShares * targetPrice;
                    const profit = holdingValue - totalSpent;
                    const profitRate = totalSpent > 0 ? (profit / totalSpent) * 100 : 0;
                    const companyMarketCap = (targetPrice / currentPrice) * marketCap / 100000000; // 转换为亿单位
                    
                    data.profitAnalysis.push({
                        targetPrice: targetPrice,
                        companyMarketCap: companyMarketCap,
                        holdingValue: holdingValue,
                        profit: profit,
                        profitRate: profitRate
                    });
                }
            }
            
            return data;
        }
        
        // 显示结果
        function displayResults() {
            // 显示策略A结果
            displayStrategyA();
            
            // 显示策略B结果
            displayStrategyB();
            
            // 显示对比结果
            displayComparison();
            
            // 生成建议
            generateSuggestion();
        }
        
        // 显示策略A结果
        function displayStrategyA() {
            // 检查数据是否存在
            if (!strategyAData) {
                console.error('策略A数据不存在');
                return;
            }
            
            // 更新摘要
            document.getElementById('strategyA-totalShares').textContent = formatNumber(strategyAData.totalShares);
            document.getElementById('strategyA-totalSpent').textContent = formatCurrency(strategyAData.totalSpent);
            document.getElementById('strategyA-remainingBudget').textContent = formatCurrency(strategyAData.remainingBudget);
            document.getElementById('strategyA-averageCost').textContent = strategyAData.averageCost.toFixed(2);
            
            // 清空表格
            const buyPlanTable = document.getElementById('strategyA-buyPlan').getElementsByTagName('tbody')[0];
            buyPlanTable.innerHTML = '';
            
            // 填充买入计划表格
            if (strategyAData.buyPlan && strategyAData.buyPlan.length > 0) {
                strategyAData.buyPlan.forEach(buy => {
                    const row = buyPlanTable.insertRow();
                    row.innerHTML = `
                        <td>${buy.sequence}</td>
                        <td>${formatPrice(buy.price)}</td>
                        <td>${buy.hands}</td>
                        <td>${formatNumber(buy.shares)}</td>
                        <td>${formatCurrency(buy.cost)}</td>
                        <td>${formatCurrency(buy.cumulativeCost)}</td>
                        <td>${formatCurrency(buy.remainingBudget)}</td>
                    `;
                });
            }
            
            // 清空收益分析表格
            const profitAnalysisTable = document.getElementById('strategyA-profitAnalysis').getElementsByTagName('tbody')[0];
            profitAnalysisTable.innerHTML = '';
            
            // 填充收益分析表格
            if (strategyAData.profitAnalysis && strategyAData.profitAnalysis.length > 0) {
                strategyAData.profitAnalysis.forEach(item => {
                    if (item.targetPrice >= (strategyAData.buyPlan[0]?.price || 0) * 0.8) {
                        const row = profitAnalysisTable.insertRow();
                        
                        let profitClass = 'neutral';
                        if (item.profit > 0) profitClass = 'positive';
                        if (item.profit < 0) profitClass = 'negative';
                        
                        let rateClass = 'neutral';
                        if (item.profitRate > 0) rateClass = 'positive';
                        if (item.profitRate < 0) rateClass = 'negative';
                        
                        row.innerHTML = `
                            <td>${item.targetPrice.toFixed(2)}</td>
                            <td>${item.companyMarketCap.toFixed(3)}</td>
                            <td>${formatCurrency(item.holdingValue)}</td>
                            <td class="${profitClass}">${formatCurrency(item.profit)}</td>
                            <td class="${rateClass}">${item.profitRate.toFixed(2)}%</td>
                        `;
                    }
                });
            }
            
            // 生成图表
            generateStrategyACharts();
        }
        
        // 显示策略B结果
        function displayStrategyB() {
            // 检查数据是否存在
            if (!strategyBData) {
                console.error('策略B数据不存在');
                return;
            }
            
            // 更新摘要
            document.getElementById('strategyB-totalShares').textContent = formatNumber(strategyBData.totalShares);
            document.getElementById('strategyB-totalSpent').textContent = formatCurrency(strategyBData.totalSpent);
            document.getElementById('strategyB-remainingBudget').textContent = formatCurrency(strategyBData.remainingBudget);
            document.getElementById('strategyB-averageCost').textContent = strategyBData.averageCost.toFixed(2);
            
            // 清空表格
            const buyPlanTable = document.getElementById('strategyB-buyPlan').getElementsByTagName('tbody')[0];
            buyPlanTable.innerHTML = '';
            
            // 填充买入计划表格
            if (strategyBData.buyPlan && strategyBData.buyPlan.length > 0) {
                strategyBData.buyPlan.forEach(buy => {
                    const row = buyPlanTable.insertRow();
                    row.innerHTML = `
                        <td>${buy.sequence}</td>
                        <td>${formatPrice(buy.price)}</td>
                        <td>${buy.hands}</td>
                        <td>${formatNumber(buy.shares)}</td>
                        <td>${formatCurrency(buy.cost)}</td>
                        <td>${formatCurrency(buy.cumulativeCost)}</td>
                        <td>${formatCurrency(buy.remainingBudget)}</td>
                    `;
                });
            }
            
            // 清空收益分析表格
            const profitAnalysisTable = document.getElementById('strategyB-profitAnalysis').getElementsByTagName('tbody')[0];
            profitAnalysisTable.innerHTML = '';
            
            // 填充收益分析表格
            if (strategyBData.profitAnalysis && strategyBData.profitAnalysis.length > 0) {
                strategyBData.profitAnalysis.forEach(item => {
                    if (item.targetPrice >= (strategyBData.buyPlan[0]?.price || 0) * 0.8) {
                        const row = profitAnalysisTable.insertRow();
                        
                        let profitClass = 'neutral';
                        if (item.profit > 0) profitClass = 'positive';
                        if (item.profit < 0) profitClass = 'negative';
                        
                        let rateClass = 'neutral';
                        if (item.profitRate > 0) rateClass = 'positive';
                        if (item.profitRate < 0) rateClass = 'negative';
                        
                        row.innerHTML = `
                            <td>${item.targetPrice.toFixed(2)}</td>
                            <td>${item.companyMarketCap.toFixed(3)}</td>
                            <td>${formatCurrency(item.holdingValue)}</td>
                            <td class="${profitClass}">${formatCurrency(item.profit)}</td>
                            <td class="${rateClass}">${item.profitRate.toFixed(2)}%</td>
                        `;
                    }
                });
            }
            
            // 生成图表
            generateStrategyBCharts();
        }
        
        // 显示对比结果
        function displayComparison() {
            // 检查数据是否存在
            if (!strategyAData || !strategyBData) {
                console.error('对比数据不存在');
                return;
            }
            
            // 更新对比表格
            document.getElementById('comparison-totalSpent-A').textContent = formatCurrency(strategyAData.totalSpent);
            document.getElementById('comparison-totalSpent-B').textContent = formatCurrency(strategyBData.totalSpent);
            document.getElementById('comparison-totalShares-A').textContent = formatNumber(strategyAData.totalShares);
            document.getElementById('comparison-totalShares-B').textContent = formatNumber(strategyBData.totalShares);
            document.getElementById('comparison-averageCost-A').textContent = strategyAData.averageCost.toFixed(2);
            document.getElementById('comparison-averageCost-B').textContent = strategyBData.averageCost.toFixed(2);
            document.getElementById('comparison-breakEven-A').textContent = strategyAData.averageCost.toFixed(2);
            document.getElementById('comparison-breakEven-B').textContent = strategyBData.averageCost.toFixed(2);
            
            const returnRateA = ((strategyAData.averageCost - parseFloat(document.getElementById('currentPrice').value)) / parseFloat(document.getElementById('currentPrice').value) * 100);
            const returnRateB = ((strategyBData.averageCost - parseFloat(document.getElementById('currentPrice').value)) / parseFloat(document.getElementById('currentPrice').value) * 100);
            
            document.getElementById('comparison-returnRate-A').textContent = returnRateA > 0 ? `+${returnRateA.toFixed(2)}%` : `${returnRateA.toFixed(2)}%`;
            document.getElementById('comparison-returnRate-B').textContent = returnRateB > 0 ? `+${returnRateB.toFixed(2)}%` : `${returnRateB.toFixed(2)}%`;
            
            // 生成对比图表
            generateComparisonCharts();
        }
        
        // 生成策略A图表
        function generateStrategyACharts() {
            // 检查数据是否存在
            if (!strategyAData || !strategyAData.profitAnalysis || strategyAData.profitAnalysis.length === 0) {
                console.error('策略A数据不存在或为空');
                return;
            }
            
            // 收益与收益率图表
            const profitCtx = document.getElementById('strategyA-profitChart').getContext('2d');
            const filteredAnalysis = strategyAData.profitAnalysis.filter(item => 
                item.targetPrice >= (strategyAData.buyPlan[0]?.price || 0) * 0.8
            ).slice(0, 20);
            
            if (filteredAnalysis.length === 0) {
                console.error('策略A过滤后的数据为空');
                return;
            }
            
            const profitLabels = filteredAnalysis.map(item => item.targetPrice.toFixed(1));
            const holdingValues = filteredAnalysis.map(item => item.holdingValue);
            const profits = filteredAnalysis.map(item => item.profit);
            const profitRates = filteredAnalysis.map(item => item.profitRate);
            
            if (window.strategyAProfitChart) {
                window.strategyAProfitChart.destroy();
            }
            
            const marketTypeAProfit = document.getElementById('marketType').value;
            const currencyUnitAProfit = marketTypeAProfit === 'US' ? '美元' : '港元';
            
            window.strategyAProfitChart = new Chart(profitCtx, {
                type: 'line',
                data: {
                    labels: profitLabels,
                    datasets: [
                        {
                            label: `持仓价值 (${currencyUnitAProfit})`,
                            data: holdingValues,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderWidth: 3,
                            yAxisID: 'y',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#3498db',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        },
                        {
                            label: `收益 (${currencyUnitAProfit})`,
                            data: profits,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 136, 0.2)',
                            borderWidth: 3,
                            yAxisID: 'y',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#2ecc71',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        },
                        {
                            label: '收益率 (%)',
                            data: profitRates,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.2)',
                            borderWidth: 3,
                            yAxisID: 'y1',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#e74c3c',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    stacked: false,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: `金额 (${currencyUnitAProfit})`,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '收益率 (%)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        }
                    }
                }
            });
            
            // 买入计划图表
            const buyPlanCtx = document.getElementById('strategyA-buyPlanChart').getContext('2d');
            
            // 检查买入计划数据
            if (!strategyAData.buyPlan || strategyAData.buyPlan.length === 0) {
                console.error('策略A买入计划数据为空');
                return;
            }
            
            const buyPlanLabels = strategyAData.buyPlan.map(item => `第${item.sequence}次`);
            const buyPrices = strategyAData.buyPlan.map(item => item.price);
            const buyCosts = strategyAData.buyPlan.map(item => item.cost / 1000);
            
            if (window.strategyABuyPlanChart) {
                window.strategyABuyPlanChart.destroy();
            }
            
            const marketTypeA = document.getElementById('marketType').value;
            const currencySymbolA = marketTypeA === 'US' ? '$' : 'HK$';
            const currencyUnitA = marketTypeA === 'US' ? '千美元' : '千港元';
            
            window.strategyABuyPlanChart = new Chart(buyPlanCtx, {
                type: 'bar',
                data: {
                    labels: buyPlanLabels,
                    datasets: [
                        {
                            label: `买入价格 (${currencySymbolA})`,
                            data: buyPrices,
                            borderColor: '#9b59b6',
                            backgroundColor: 'rgba(155, 89, 182, 0.8)',
                            type: 'line',
                            order: 1,
                            borderWidth: 4,
                            pointRadius: 8,
                            pointHoverRadius: 10,
                            pointBackgroundColor: '#9b59b6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 3,
                            tension: 0.4
                        },
                        {
                            label: `支出 (${currencyUnitA})`,
                            data: buyCosts,
                            backgroundColor: [
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(155, 89, 182, 0.8)',
                                'rgba(231, 76, 60, 0.8)',
                                'rgba(243, 156, 18, 0.8)',
                                'rgba(26, 188, 156, 0.8)',
                                'rgba(52, 73, 94, 0.8)',
                                'rgba(155, 89, 182, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(231, 76, 60, 0.8)'
                            ],
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                            order: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 生成策略B图表
        function generateStrategyBCharts() {
            // 检查数据是否存在
            if (!strategyBData || !strategyBData.profitAnalysis || strategyBData.profitAnalysis.length === 0) {
                console.error('策略B数据不存在或为空');
                return;
            }
            
            // 收益与收益率图表
            const profitCtx = document.getElementById('strategyB-profitChart').getContext('2d');
            const filteredAnalysis = strategyBData.profitAnalysis.filter(item => 
                item.targetPrice >= (strategyBData.buyPlan[0]?.price || 0) * 0.8
            ).slice(0, 20);
            
            if (filteredAnalysis.length === 0) {
                console.error('策略B过滤后的数据为空');
                return;
            }
            
            const profitLabels = filteredAnalysis.map(item => item.targetPrice.toFixed(1));
            const holdingValues = filteredAnalysis.map(item => item.holdingValue);
            const profits = filteredAnalysis.map(item => item.profit);
            const profitRates = filteredAnalysis.map(item => item.profitRate);
            
            if (window.strategyBProfitChart) {
                window.strategyBProfitChart.destroy();
            }
            
            const marketTypeBProfit = document.getElementById('marketType').value;
            const currencyUnitBProfit = marketTypeBProfit === 'US' ? '美元' : '港元';
            
            window.strategyBProfitChart = new Chart(profitCtx, {
                type: 'line',
                data: {
                    labels: profitLabels,
                    datasets: [
                        {
                            label: `持仓价值 (${currencyUnitBProfit})`,
                            data: holdingValues,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderWidth: 3,
                            yAxisID: 'y',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#3498db',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        },
                        {
                            label: `收益 (${currencyUnitBProfit})`,
                            data: profits,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 136, 0.2)',
                            borderWidth: 3,
                            yAxisID: 'y',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#2ecc71',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        },
                        {
                            label: '收益率 (%)',
                            data: profitRates,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.2)',
                            borderWidth: 3,
                            yAxisID: 'y1',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#e74c3c',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    stacked: false,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: `金额 (${currencyUnitBProfit})`,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '收益率 (%)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        }
                    }
                }
            });
            
            // 买入计划图表
            const buyPlanCtx = document.getElementById('strategyB-buyPlanChart').getContext('2d');
            
            // 检查买入计划数据
            if (!strategyBData.buyPlan || strategyBData.buyPlan.length === 0) {
                console.error('策略B买入计划数据为空');
                return;
            }
            
            const buyPlanLabels = strategyBData.buyPlan.map(item => `第${item.sequence}次`);
            const buyPrices = strategyBData.buyPlan.map(item => item.price);
            const buyCosts = strategyBData.buyPlan.map(item => item.cost / 1000);
            
            if (window.strategyBBuyPlanChart) {
                window.strategyBBuyPlanChart.destroy();
            }
            
            const marketTypeB = document.getElementById('marketType').value;
            const currencySymbolB = marketTypeB === 'US' ? '$' : 'HK$';
            const currencyUnitB = marketTypeB === 'US' ? '千美元' : '千港元';
            
            window.strategyBBuyPlanChart = new Chart(buyPlanCtx, {
                type: 'bar',
                data: {
                    labels: buyPlanLabels,
                    datasets: [
                        {
                            label: `买入价格 (${currencySymbolB})`,
                            data: buyPrices,
                            borderColor: '#9b59b6',
                            backgroundColor: 'rgba(155, 89, 182, 0.8)',
                            type: 'line',
                            order: 1,
                            borderWidth: 4,
                            pointRadius: 8,
                            pointHoverRadius: 10,
                            pointBackgroundColor: '#9b59b6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 3,
                            tension: 0.4
                        },
                        {
                            label: `支出 (${currencyUnitB})`,
                            data: buyCosts,
                            backgroundColor: [
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(155, 89, 182, 0.8)',
                                'rgba(231, 76, 60, 0.8)',
                                'rgba(243, 156, 18, 0.8)',
                                'rgba(26, 188, 156, 0.8)',
                                'rgba(52, 73, 94, 0.8)',
                                'rgba(155, 89, 182, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(231, 76, 60, 0.8)'
                            ],
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                            order: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 生成对比图表
        function generateComparisonCharts() {
            // 检查数据是否存在
            if (!strategyAData || !strategyBData || 
                !strategyAData.profitAnalysis || !strategyBData.profitAnalysis ||
                strategyAData.profitAnalysis.length === 0 || strategyBData.profitAnalysis.length === 0) {
                console.error('对比图表数据不存在或为空');
                return;
            }
            
            // 收益对比图表
            const profitCtx = document.getElementById('comparison-profitChart').getContext('2d');
            
            // 找到两个策略的共同价格范围
            const minPrice = Math.max(
                strategyAData.buyPlan[0]?.price || 0,
                strategyBData.buyPlan[0]?.price || 0
            ) * 0.8;
            
            const commonAnalysisA = strategyAData.profitAnalysis.filter(item => item.targetPrice >= minPrice).slice(0, 15);
            const commonAnalysisB = strategyBData.profitAnalysis.filter(item => item.targetPrice >= minPrice).slice(0, 15);
            
            // 检查过滤后的数据
            if (commonAnalysisA.length === 0 || commonAnalysisB.length === 0) {
                console.error('对比图表过滤后的数据为空');
                return;
            }
            
            const profitLabels = commonAnalysisA.map(item => item.targetPrice.toFixed(1));
            const profitsA = commonAnalysisA.map(item => item.profit);
            const profitsB = commonAnalysisB.map(item => item.profit);
            const holdingValuesA = commonAnalysisA.map(item => item.holdingValue);
            const holdingValuesB = commonAnalysisB.map(item => item.holdingValue);
            
            if (window.comparisonProfitChart) {
                window.comparisonProfitChart.destroy();
            }
            
            const marketTypeComp = document.getElementById('marketType').value;
            const currencyUnitComp = marketTypeComp === 'US' ? '美元' : '港元';
            
            window.comparisonProfitChart = new Chart(profitCtx, {
                type: 'bar',
                data: {
                    labels: profitLabels,
                    datasets: [
                        {
                            label: `策略A 收益 (${currencyUnitComp})`,
                            data: profitsA,
                            backgroundColor: [
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(52, 152, 219, 0.8)'
                            ],
                            borderColor: '#3498db',
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false
                        },
                        {
                            label: `策略B 收益 (${currencyUnitComp})`,
                            data: profitsB,
                            backgroundColor: [
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)',
                                'rgba(46, 204, 136, 0.8)'
                            ],
                            borderColor: '#2ecc71',
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `收益 (${currencyUnitComp})`,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        }
                    }
                }
            });
            
            // 收益率对比图表
            const rateCtx = document.getElementById('comparison-rateChart').getContext('2d');
            const profitRatesA = commonAnalysisA.map(item => item.profitRate);
            const profitRatesB = commonAnalysisB.map(item => item.profitRate);
            
            if (window.comparisonRateChart) {
                window.comparisonRateChart.destroy();
            }
            
            window.comparisonRateChart = new Chart(rateCtx, {
                type: 'line',
                data: {
                    labels: profitLabels,
                    datasets: [
                        {
                            label: '策略A 收益率 (%)',
                            data: profitRatesA,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#3498db',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        },
                        {
                            label: '策略B 收益率 (%)',
                            data: profitRatesB,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 136, 0.2)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#2ecc71',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '收益率 (%)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 生成建议
        function generateSuggestion() {
            const suggestionElement = document.getElementById('strategy-suggestion');
            
            // 检查数据是否存在
            if (!strategyAData || !strategyBData) {
                suggestionElement.innerHTML = '<p>请先生成策略分析以获取建议。</p>';
                return;
            }
            
            const currentPrice = parseFloat(document.getElementById('currentPrice').value);
            
            // 简单的策略建议逻辑
            if (strategyAData.averageCost < currentPrice && strategyBData.averageCost > currentPrice) {
                suggestionElement.innerHTML = `
                    <p><strong>策略建议：</strong></p>
                    <p>当前股价为 ${currentPrice.toFixed(2)} 港元，高于策略A的平均成本(${strategyAData.averageCost.toFixed(2)} 港元)，但低于策略B的平均成本(${strategyBData.averageCost.toFixed(2)} 港元)。</p>
                    <p><strong>推荐策略A</strong>，因为该策略在股价下跌时逐步买入，成本较低，当前已处于盈利状态。这种策略适合震荡市或预期股价可能继续下跌的市场环境。</p>
                    <p>策略B需要股价进一步上涨才能回本，风险相对较高。</p>
                `;
            } else if (strategyAData.averageCost > currentPrice && strategyBData.averageCost < currentPrice) {
                suggestionElement.innerHTML = `
                    <p><strong>策略建议：</strong></p>
                    <p>当前股价为 ${currentPrice.toFixed(2)} 港元，低于策略A的平均成本(${strategyAData.averageCost.toFixed(2)} 港元)，但高于策略B的平均成本(${strategyBData.averageCost.toFixed(2)} 港元)。</p>
                    <p><strong>推荐策略B</strong>，因为该策略在股价上涨时买入，表明市场趋势向好，当前已处于盈利状态。这种策略适合牛市或预期股价将继续上涨的市场环境。</p>
                    <p>策略A目前处于亏损状态，需要股价反弹才能回本。</p>
                `;
            } else if (strategyAData.averageCost < strategyBData.averageCost) {
                suggestionElement.innerHTML = `
                    <p><strong>策略建议：</strong></p>
                    <p>策略A的平均成本(${strategyAData.averageCost.toFixed(2)} 港元)低于策略B的平均成本(${strategyBData.averageCost.toFixed(2)} 港元)。</p>
                    <p>如果预期市场将震荡或下行，<strong>推荐策略A</strong>，因为它通过在股价下跌时买入，有效降低了持仓成本，风险相对较小。</p>
                    <p>如果预期市场将强劲上涨，可以考虑策略B，但需要承担更高的成本风险。</p>
                `;
            } else {
                suggestionElement.innerHTML = `
                    <p><strong>策略建议：</strong></p>
                    <p>两种策略的平均成本相近，策略A为 ${strategyAData.averageCost.toFixed(2)} 港元，策略B为 ${strategyBData.averageCost.toFixed(2)} 港元。</p>
                    <p>如果市场趋势不确定，<strong>推荐策略A</strong>，因为它在股价下跌时买入，可以更好地控制风险，适合长期投资。</p>
                    <p>如果对市场上涨有较强信心，可以选择策略B，但需要注意控制风险。</p>
                `;
            }
        }
        
        // 格式化数字
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // 格式化货币
        function formatCurrency(amount) {
            const marketType = document.getElementById('marketType').value;
            const currencySymbol = marketType === 'US' ? '$' : 'HK$';
            return currencySymbol + amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // 格式化价格 (根据市场类型调整精度)
        function formatPrice(price) {
            const marketType = document.getElementById('marketType').value;
            if (marketType === 'US') {
                return price.toFixed(0); // 美股价格保留整数
            } else {
                return price.toFixed(2); // 港股价格保留两位小数
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            addInputListeners(); // 添加输入事件监听器
            validateForm(); // 初始验证表单
            // 可以在这里添加初始数据或示例
            // calculateStrategies(); // 如果希望页面加载后自动计算，取消注释这行
        });
    </script>
</body>
</html>
